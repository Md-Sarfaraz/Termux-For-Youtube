#!/data/data/com.termux/files/usr/bin/bash

QUEUE="$HOME/.ytdlp/queue.txt"
LOCK="$HOME/.ytdlp/lock"

mkdir -p "$HOME/.ytdlp"
touch "$QUEUE"

URL="$1"
MODE="${2:-best}"

if [[ -z "$URL" ]]; then
  echo "Usage:"
  echo "  yt <url> [audio|240|360|480|720|1080|best]"
  exit 1
fi

echo "$URL|$MODE" >> "$QUEUE"
echo "[+] Added to queue: $MODE"

cleanup() {
  rm -f "$LOCK"
}
trap cleanup EXIT INT TERM

process_queue() {
  while true; do
    LINE="$(head -n 1 "$QUEUE")"
    [[ -z "$LINE" ]] && break

    IFS='|' read -r url mode <<< "$LINE"
    sed -i '1d' "$QUEUE"

    echo "[+] Downloading: $url ($mode)"

    case "$mode" in
      audio)
        yt-dlp -x --audio-format mp3 --continue --retries infinite "$url"
        ;;
      240)
        yt-dlp -f "best[height<=240]" --continue --retries infinite "$url"
        ;;
      360)
        yt-dlp -f "best[height<=360]" --continue --retries infinite "$url"
        ;;
      480)
        yt-dlp -f "best[height<=480]" --continue --retries infinite "$url"
        ;;
      720)
        yt-dlp -f "best[height<=720]" --continue --retries infinite "$url"
        ;;
      1080)
        yt-dlp -f "best[height<=1080]" --continue --retries infinite "$url"
        ;;
      *)
        yt-dlp --continue --retries infinite "$url"
        ;;
    esac

    termux-notification -t "Download Finished" -c "$url" --sound
  done
}

if [[ ! -f "$LOCK" ]]; then
  touch "$LOCK"
  process_queue &
fi
